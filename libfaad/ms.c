/*{{{  includes*/
#include "common.h"
#include "structs.h"

#include "syntax.h"
#include "ms.h"
#include "is.h"
#include "pns.h"
/*}}}*/

void ms_decode(ic_stream *ics, ic_stream *icsr, real_t *l_spec, real_t *r_spec, uint16_t frame_len) {

  uint8_t g, b, sfb;
  uint8_t group = 0;
  uint16_t nshort = frame_len/8;

  uint16_t i, k;
  real_t tmp;

  if (ics->ms_mask_present >= 1) {
    for (g = 0; g < ics->num_window_groups; g++) {
      for (b = 0; b < ics->window_group_length[g]; b++) {
        for (sfb = 0; sfb < ics->max_sfb; sfb++) {
          /* If intensity stereo coding or noise substitution is on
             for a particular scalefactor band, no M/S stereo decoding is carried out. */
          if ((ics->ms_used[g][sfb] || ics->ms_mask_present == 2) &&
              !is_intensity(icsr, g, sfb) && !is_noise(ics, g, sfb)) {
            for (i = ics->swb_offset[sfb]; i < min(ics->swb_offset[sfb+1], ics->swb_offset_max); i++) {
              k = (group*nshort) + i;
              tmp = l_spec[k] - r_spec[k];
              l_spec[k] = l_spec[k] + r_spec[k];
              r_spec[k] = tmp;
              }
            }
          }
        group++;
        }
      }
    }
  }
